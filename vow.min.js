/**
 * Vow
 *
 * Copyright (c) 2012 Filatov Dmitry (dfilatov@yandex-team.ru)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 * @version 0.1.9
 */(function(e){var t,n=typeof process=="object"?process.nextTick:e.setImmediate?e.setImmediate:e.postMessage?function(){var t=[],n="__promise"+ +(new Date),r=function(e){if(e.data===n){e.stopPropagation&&e.stopPropagation();var r=t,i=0,s=t.length;t=[];while(i<s)r[i++]()}};return e.addEventListener?e.addEventListener("message",r,!0):e.attachEvent("onmessage",r),function(r){t.push(r)===1&&e.postMessage(n,"*")}}():"onreadystatechange"in document.createElement("script")?function(e){var t=document.createElement("script");t.onreadystatechange=function(){t.parentNode.removeChild(t),t=t.onreadystatechange=null,e()},(document.documentElement||document.body).appendChild(t)}:setTimeout(fn,0),r=function(e){n(function(){throw e})},i=function(e){return typeof e=="function"},s=function(e){this._res=e,this._isFulfilled=typeof e!="undefined",this._isRejected=!1,this._fulfilledCallbacks=[],this._rejectedCallbacks=[]};s.prototype={valueOf:function(){return this._res},isFulfilled:function(){return this._isFulfilled},isRejected:function(){return this._isRejected},isResolved:function(){return this._isFulfilled||this._isRejected},fulfill:function(e){if(this.isResolved())return;this._isFulfilled=!0,this._res=e,this._callCallbacks(this._fulfilledCallbacks),this._fulfilledCallbacks=this._rejectedCallbacks=t},reject:function(e){if(this.isResolved())return;this._isRejected=!0,this._res=e,this._callCallbacks(this._rejectedCallbacks),this._fulfilledCallbacks=this._rejectedCallbacks=t},then:function(e,t){var n=new s,r;return this._isRejected||(r={promise:n,fn:e},this._isFulfilled?this._callCallbacks([r]):this._fulfilledCallbacks.push(r)),this._isFulfilled||(r={promise:n,fn:t},this._isRejected?this._callCallbacks([r]):this._rejectedCallbacks.push(r)),n},fail:function(e){return this.then(t,e)},spread:function(e,t){return this.then(function(t){return e.apply(this,t)},t)},done:function(){this.fail(r)},timeout:function(e){var t=new s,n=setTimeout(function(){t.reject(Error("timed out"))},e);return this.then(function(e){clearTimeout(n),t.fulfill(e)},function(e){clearTimeout(n),t.reject(e)}),t},_callCallbacks:function(e){var t=e.length;if(!t)return;var r=this._res,s=this.isFulfilled();n(function(){var n=0,u,a,f;while(n<t){u=e[n++],a=u.promise,f=u.fn;if(i(f)){var l;try{l=f(r)}catch(c){a.reject(c);continue}o.isPromise(l)?function(e){l.then(function(t){e.fulfill(t)},function(t){e.reject(t)})}(a):a.fulfill(l)}else s?a.fulfill(r):a.reject(r)}})}};var o={promise:function(e){return this.isPromise(e)?e:new s(e)},when:function(e,t,n){return this.promise(e).then(t,n)},fail:function(e,n){return this.when(e,t,n)},spread:function(e,t,n){return this.promise(e).spread(t,n)},done:function(e){this.isPromise(e)&&e.done()},isPromise:function(e){return e&&i(e.then)},isFulfilled:function(e){return this.isPromise(e)?e.isFulfilled():!0},isRejected:function(e){return this.isPromise(e)?e.isRejected():!1},isResolved:function(e){return this.isPromise(e)?e.isResolved():!0},fulfill:function(e){return this.when(e,t,function(e){return e})},reject:function(e){return this.when(e,function(e){var t=new s;return t.reject(e),t})},resolve:function(e){return this.isPromise(e)?e:this.when(e)},forEach:function(e,t,n){var r=0,i=e.length;while(r<i)this.when(e[r++],t,n)},all:function(e){var t=e.length;if(!t)return new s([]);var n=new s,r=function(){if(!--t){var r=[],i;while(i=e[t++])r.push(i.valueOf());n.fulfill(r)}},i=function(e){n.reject(e)};return this.forEach(e,r,i),n},allResolved:function(e){var t=e.length;if(!t)return new s([]);var n=new s,r=function(){--t||n.fulfill(e)};return this.forEach(e,r,r),n},any:function(e){var t=e.length,n=new s;if(!t)return n.reject(Error()),n;var r=0,i,o=function(e){n.fulfill(e)},u=function(e){r||(i=e),++r===t&&n.reject(i)};return this.forEach(e,o,u),n},timeout:function(e,t){return this.promise(e).timeout(t)}};typeof exports=="object"?module.exports=o:typeof define=="function"?define(function(e,t,n){n.exports=o}):e.Vow=o})(this);